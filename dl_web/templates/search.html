{%- extends "digital-land-frontend/dlf-base.html" %} {% block page_title %}Entity search prototype{% endblock %}
{% set includesMap = true %}
{%- from "digital-land-frontend/components/feedback-panel/macro.html" import dlFeedbackPanel %}
{%- from "govuk-jinja-components/components/input/macro.jinja" import govukInput %}
{%- from "govuk-jinja-components/components/fieldset/macro.jinja" import govukFieldset %}
{%- from "govuk-jinja-components/components/button/macro.jinja" import govukButton %}
{%- from "govuk-jinja-components/components/tag/macro.jinja" import govukTag -%}
{%- from "digital-land-frontend/components/map/macro.html" import dlMap %}
{%- from "digital-land-frontend/components/filter-group/macro.html" import dlFilterGroup %}
{%- from "digital-land-frontend/components/dl-helpers.html" import random_int %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="/static/stylesheets/application.css" />
{% endblock %}

{% block main %}
<main id="content" role="main">
  <section class="govuk-width-container govuk-!-padding-top-6 govuk-!-padding-bottom-6">
    {% call govukFieldset({ "legend": { "text": "Search for planning and housing data", "classes": "govuk-fieldset__legend--l govuk-!-margin-bottom-8", "isPageHeading": true } }) %}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        {% set search_form_url = "/entity" %}
        {% include 'partials/search-facets.html' %}

        <!--<form action="/entity" method="get" class="app-search">
          {{ govukInput({ "label": { "text": "Latitude", }, "id": "latitude", "name": "latitude" }) }} {{ govukInput({ "label": { "text": "Longitude", }, "id": "longitude", "name": "longitude" }) }}
          {{ govukButton({ "text": "Search", "classes": "govuk-!-margin-bottom-0" }) }}
        </form>-->
      </div>
      <!-- /.govuk-grid-column-one-third -->
      <div class="govuk-grid-column-two-thirds">
        {% if data and data.count > 0 %}
        <div class="app-results-summary">
          <h2 class="app-results-summary__title">{{ data.count }} Result{% if data.count > 1 %}s{% endif %}</h2>

          {% macro removeFilterButton(params) %}
          <a href="{{ params.url }}" class="app-applied-filter__button" arial-label="Remove filter for {{ params.filter.name }}">
            <span class="app-facet-tag__icon" aria-hidden="true">
              <svg width="30px" height="30px" viewBox="0 0 30 30" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                  <g id="Group" fill="#000000" fill-rule="nonzero">
                    <path
                      d="M2.84386208,29.6395923 C2.1083442,29.6823572 1.38499138,29.4378396 0.826334681,28.9576007 C-0.275444894,27.8492707 -0.275444894,26.0592298 0.826334681,24.9508998 L24.9516952,0.825445695 C26.0976433,-0.246857017 27.8958254,-0.187248253 28.9681281,0.958699821 C29.9377765,1.99497526 29.9942972,3.58775513 29.1004465,4.69009616 L4.83294196,28.9576007 C4.28149071,29.4309149 3.56974148,29.6749646 2.84386208,29.6395923 Z"
                      id="Path"
                    ></path>
                    <path
                      d="M26.9408687,29.6395923 C26.1954316,29.6364107 25.4809686,29.3405191 24.9516952,28.8155503 L0.8262411,4.69000258 C-0.194500497,3.49801446 -0.0557253049,1.70413689 1.13626282,0.683301721 C2.20014357,-0.22776724 3.76915479,-0.22776724 4.83294196,0.683301721 L29.1004465,24.8087558 C30.2461138,25.8813393 30.3053483,27.679615 29.2327649,28.8252824 C29.1900936,28.8708545 29.1460187,28.9149294 29.1004465,28.9576007 C28.5062304,29.4743348 27.7242046,29.7212854 26.9408687,29.6395923 L26.9408687,29.6395923 Z"
                      id="Path"
                    ></path>
                  </g>
                </g>
              </svg>
            </span>
            <span class="app-facet-tag__label u-font-mono">{{ params.filter.value }}</span>
          </a>
          {% endmacro %}
          {% if active_filters|length > 0 %}
          <div class="app-applied-filters">
            {% if query.params and query.params.get('typology') %}
            <div class="app-applied-filter__group">
              <span class="app-applied-filter__name govuk-!-font-weight-bold">Typology:</span>
              {% for filter in query.params.get('typology') %}
              <span class="app-applied-filter__item">
                {{ removeFilterButton({
                  "filter": {
                    "name": "typology",
                    "value": filter
                  },
                  "url": "#"
                }) }}
              </span>
              {% endfor %}
            </div>
            {% endif %}  
            {% if query.params and query.params.get('dataset') %}
            <div class="app-applied-filter__group">
              <span class="app-applied-filter__name govuk-!-font-weight-bold">Dataset:</span>
              {% for filter in query.params.get('dataset') %}
              <span class="app-applied-filter__item">
                {{ removeFilterButton({
                  "filter": {
                    "name": "dataset",
                    "value": filter
                  },
                  "url": "#"
                }) }}
              </span>
              {% endfor %}
            </div>
            {% endif %}   
          </div>
          {% endif %}
          <!-- /.app-facets-summary -->
        </div>
        <!-- /.app-results-summary -->

        <div class="app-results-body">

          <ul class="app-results-list">
            {% for row in data.results %}
            {% set propertiesArr = [
              { "key": "Dataset", "value": row["dataset"] },
              { "key": "Name", "value": row["name"] },
              { "key": "Entry-date", "value": row["entry_date"] },
              { "key": "Reference", "value": row["reference"] },
            ] %}
            <li class="app-results-list__item">
              <article class="app-card app-card--result">
                <div class="app-card__header">
                  <div class="app-card__header__primary">
                    <h3 class="app-card__title">{{ row["name"] }}</h3>
                  </div>
                  <div class="app-card__header__secondary">
                    {{ govukTag({ "text": row["typology"] }) }}
                    <dl class="app-card__datalist">
                      <div class="app-card__datalist__row">
                        <dd class="app-card__datalist__value"><a href="{{ row['entity'] }}/" class="govuk-link">{{ row["entity"] }}</a></dd>
                      </div>
                    </dl>
                  </div>
                </div>

                {# optional container for an image or map, question: does a map need to be anything more than a static image in results? #}
                {% if "geometry" in row["geojson"] %}
                <div class="app-card__media">{% set mapId = row["entity"] ~ "-map" %} {{ dlMap({ "id": mapId, "wrapper_classes": "app-card__map-container" }) }}</div>
                {% endif %}
                <div class="app-card__body">
                  {% if row["description"] %}
                  <div class="app-card__description">
                    <p class="govuk-body">{{ row["description"] }}</p>
                  </div>
                  {% endif %}

                  <div class="app-card__row">
                    <div class="app-card__properties">
                      <dl class="govuk-summary-list govuk-!-margin-bottom-0">
                        {% for property in propertiesArr %}
                        <div class="govuk-summary-list__row">
                          <dt class="govuk-summary-list__key">{{ property.key }}</dt>
                          <dd class="govuk-summary-list__value">{{ property.value }}</dd>
                        </div>
                        {% endfor %}
                      </dl>
                    </div>
                  </div>
                </div>
              </article>
              <!-- /.app-card -->
            </li>
            {% endfor %}
          </ul>
          <!-- /.app-results-list -->

          {# Anything within this div becomes 'sticky' to the bottom upon scroll #}
          <div class="app-results-footer">

            <div class="app-results-actions">
              <h3 class="app-results-actions__title govuk-heading-s">Download these results</h3>
              <div class="app-results-actions__row">
                <div class="app-results-actions__row-title">
                  <p class="govuk-body">Format:</p>
                </div>
                <div class="app-results-actions__row-content">
                  <ul class="app-list app-list--files">
                    <li class="app-list__item"><a href="#" class="govuk-link">CSV File</a></li>
                    <li class="app-list__item"><a href="#" class="govuk-link">JSON</a></li>
                    <li class="app-list__item"><a href="#" class="govuk-link">geoJSON</a></li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
          <!-- /.app-results-footer -->

        </div>
        <!-- /.app-results-body -->

        {% endif %}
      </div>
      <!-- /.govuk-grid-column-two-thirds -->
    </div>
    <!-- /#search.govuk-grid-row -->
    {% endcall %}
  </section>
</main>
{% endblock %} {% block bodyEnd %} {{ super() }} {% if data and data.count > 0 %}
<script>
  const results = {{ data.results|tojson }};
  results.forEach(function (result) {
      console.log(result);
      if (!result.geojson.hasOwnProperty("geometry")) {
        return;
      }
      const mapElementId = result.entity + "-map"
      const $mapElement = document.getElementById(mapElementId)
      const dlmap = new DLMaps.Map($mapElement).init({})
      // create a named map layer so we can use that to fitbounds
      var mapLayer = L.geoJSON().addTo(dlmap.map);
      mapLayer.addData(result.geojson);
      dlmap.map.fitBounds(mapLayer.getBounds())
  })
</script>
{% endif %}
<script>
  var $filters = document.querySelectorAll('[data-module="selected-counter"]')
  $filters.forEach(filter => {
    new window.DLFrontend.SelectedCounter(filter).init()
  })
  
  var $filterCheckboxes = document.querySelectorAll('[data-module="filter-checkboxes"]')
  $filterCheckboxes.forEach(el => {
    new window.DLFrontend.FilterCheckboxes(el).init()
  })
</script>
{% endblock bodyEnd %}

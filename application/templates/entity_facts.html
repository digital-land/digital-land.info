{% extends "layouts/layout.html" %}
{% set templateName = "dl-info/entity.html" %}

{%- from "govuk_frontend_jinja/components/details/macro.html" import govukDetails %}
{%- from "digital-land-frontend/components/map/macro.jinja" import dlLeafletMap %}
{%- from "digital-land-frontend/components/data-record/macro.jinja" import dlDataRecordPanel %}
{%- from "digital-land-frontend/components/data-reference-cell/macro.jinja" import dlDataReferenceCell %}
{%- from "digital-land-frontend/components/data-table/macro.jinja" import dlDataTableWrapper %}
{%- from "components/summary-card/macro.jinja" import appSummaryCard %}

{% if row['name'] %}
  {%- set row_name = row['name'] %}
{%- elif row['reference'] %}
  {%- set row_name = row['reference'] %}
{%- else %}
  {%- set row_name = "Not Named" %}
{%- endif %}

{% set geometry_url = "/entity/" + row["entity"] | string + ".geojson" if row['typology'] == "geography" else
  None %}
{% if geometry_url or geojson_features %}
  {% set includesMap = true %}
{% endif %}

{%- block pageTitle %}{{ row_name }} | {{ pipeline_name|capitalize }} | Digital Land{% endblock -%}

{%- block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <span class="govuk-caption-xl">{{ pipeline_name|replace("-", " ")|capitalize }}</span>
      <h1 class="govuk-heading-xl">{{ row_name }}</h1>
    </div>

    <div class="govuk-grid-column-three-quarters">
      {% call appSummaryCard({ 'classes': 'govuk-!-margin-bottom-9' }) %}
        <table class="govuk-table">
          <thead class="govuk-table__head">
            <tr class="govuk-table_row">
              f.entity, f.fact, f.field,f.value,min(fr.entry_date) as earliest_entry_date , max(fr.entry_date) as latest_entry_date,
              <th scope="col" class="govuk-table__header">Fact</th>
              <th scope="col" class="govuk-table__header">Field</th>
              <th scope="col" class="govuk-table__header">Value</th>
              <th scope="col" class="govuk-table__header">Earliest Entry Date</th>
              <th scope="col" class="govuk-table__header">Latest Entry Date</th>
              <th scope="col" class="govuk-table__header">Resource History</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for fact in facts %}
              <tr class="govuk-table__row">
                <td class="govuk-table__cell app-table__cell">
                  {{fact.fact}}
                </td>
                <td class="govuk-table__cell app-table__cell">
                  {{fact.field}}
                </td>
                <td class="govuk-table__cell app-table__cell">
                  {{fact.value}}
                </td>
                <td class="govuk-table__cell app-table__cell">
                  {{fact.earliest_entry_date}}
                </td>
                <td class="govuk-table__cell app-table__cell">
                  {{fact.latest_entry_date}}
                </td>
                <td class="govuk-table__cell app-table__cell">
                  {{fact.resource_history}}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endcall %}
    </div>

    <div class="govuk-grid-column-full">
    {% block recordGeometry -%}
      {%- if includesMap %}
        <h2 class="govuk-heading-m">Geographical area</h2>

        {% set noteHTML %}
        <a class="js-hidden dl-link-national-map" href="#">See on national map.</a>
        {% endset %}

        {{- dlLeafletMap({
        "id": "dlMap",
        "wrapper_classes": "govuk-!-margin-top-4",
        "attributes": {
            "data-geojson-urls": geometry_url
        },
        "height": "460",
        "notePanel": {
            "html": noteHTML
        }
        }) -}}

        <div class="govuk-!-margin-top-2 govuk-!-margin-bottom-6">
          <a download class="app-page-action-button" href="/entity/{{row["entity"]}}.geojson">Download geojson</a>
        </div>
      {%- endif %}
    {%- endblock recordGeometry %}

    <details class="govuk-details" data-module="govuk-details">
      <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      Facts
    </span>
      </summary>
      <div class="govuk-details__text">
        <pre>
        {{ facts | tojson(indent=4)}}
        </pre>
      </div>
    </details>

    </div>


    <details class="govuk-details" data-module="govuk-details">
      <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      Facts
    </span>
      </summary>
      <div class="govuk-details__text">
        <pre>
        {{ facts | tojson(indent=4)}}
        </pre>
      </div>
    </details>

    {%- if history_enabled %}
      <div id="history">
        {#{%- block entryHistory %}#}
        {#{%- endblock entryHistory %}#}
      </div>
    {%- endif %}

    {%- if provenance %}
      <div id="provenance">
        <h2 class="govuk-heading-m dl-subnav__heading">Provenance</h2>
      </div>
    {% endif -%}

    {% block recordReferences -%}
      {% if references %}
        <div id="referenced-by">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <h2 class="govuk-heading-m dl-subnav__heading">Referenced by</h2>
              <p class="govuk-body">This record is referenced by {{ references|total_items }} other planning related data record{{ "" if references|total_items == 1 else "s" }}.</p>
              {% if references|length > 0 -%}
                {% for type, refs in references.items() %}
                  <h3 class="govuk-heading-s">{{ type|capitalize }}</h3>
                  <ul class="govuk-list govuk-list--bullet">
                    {%- for ref in refs %}
                      <li>
                        <a href={{ entity_prefix|default('') }}{{ ref["href"] }}>{{ ref["text"] }}</a>
                        <span class="secondary-text data-reference">({{ ref["id"] }})</span>
                      </li>
                    {% endfor -%}
                  </ul>
                {% endfor %}
              {% endif -%}
            </div>
          </div>
        </div>
      {% endif %}
    {% endblock recordReferences -%}
  </div>
{%- endblock content %}}

{%- block pageScripts %}
  {%- if includesMap %}
    <script>
      const datasetName = "{{ pipeline_name }}"
      const $mapElement = document.querySelector('[data-module="boundary-map"]')
      const $nationalMapLink = document.querySelector('.dl-link-national-map')
      const mapParams = {
        initZoomCallback: function (featureGroup, map) {
          console.log("initial load completed")
          // do we need to check there isn't more than one shape?
          const center = featureGroup
            .getBounds()
            .getCenter()
          const zoom = map.getZoom()
          let url = `http://digital-land.github.io/map?layer=${datasetName}#${center
            .lat},${center
            .lng},${zoom}z`
            console
            .log(url)
          if ($nationalMapLink) {
            // only show this for the datasets we've added to the national map
            $nationalMapLink.href = url
            $nationalMapLink
              .classList
              .remove("js-hidden")
          }
        }
      }

      {% if geometry_url %}
        mapParams.geojsonURLs = ["{{ geometry_url }}"]
      {% elif geojson_features %}
        mapParams.geojsonFeatures = [{{ geojson_features|tojson }}]
      {% endif %}

      const mapComponent = new DLMaps
        .Map($mapElement)
        .init(mapParams)
    </script>
  {% endif %}

  <script>
    const $subNavTabs = document.querySelector('[data-module="dl-subnav"]')
    const subNavTabsComponent = new DLFrontend
      .SubNavTabs($subNavTabs)
      .init({})
  </script>

{%- endblock %}

{% extends "layouts/layout.html" %}
{% set templateName = "dl-info/entity.html" %}

{%- from "govuk_frontend_jinja/components/details/macro.html" import govukDetails %}
{%- from "govuk_frontend_jinja/components/tabs/macro.html" import govukTabs %}
{%- from "digital-land-frontend/components/map/macro.jinja" import dlLeafletMap %}
{%- from "digital-land-frontend/components/data-record/macro.jinja" import dlDataRecordPanel %}
{%- from "digital-land-frontend/components/data-reference-cell/macro.jinja" import dlDataReferenceCell %}
{%- from "digital-land-frontend/components/data-table/macro.jinja" import dlDataTableWrapper %}
{%- from "components/summary-card/macro.jinja" import appSummaryCard %}
{%- from "components/entity-value/macro.jinja" import entityValue %}
{%- from "components/entity-field/macro.jinja" import entityField %}

{% if row['name'] %}
  {%- set row_name = row['name'] %}
{%- elif row['reference'] %}
  {%- set row_name = row['reference'] %}
{%- else %}
  {%- set row_name = "Not Named" %}
{%- endif %}

{% set geometry_url = "/entity/" + row["entity"] | string + ".geojson" if row['typology'] == "geography" else
  None %}
{% if geometry_url or geojson_features %}
  {% set includesMap = true %}
{% endif %}

{% block pageAssets %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.5.1/styles/stackoverflow-light.min.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.5.1/highlight.min.js"></script>
{% endblock %}

{%- block pageTitle %}{{ row_name }} | {{ pipeline_name|capitalize }} | Digital Land{% endblock -%}

{%- block breadcrumbs -%}
  {{- govukBreadcrumbs({
    "items": [
        {
          "text": "Digital Land",
          "href": "/"
        },
        {
          "text": "Entity",
          "href": "/entity"
        },
        {
          "text": row["entity"]
        }
      ]
    }) -}}
{%- endblock -%}

{%- block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <span class="govuk-caption-xl">{{ pipeline_name|replace("-", " ")|capitalize }}</span>
      <h1 class="govuk-heading-xl">{{ row_name }}</h1>
    </div>

    <div class="govuk-grid-column-three-quarters">
      {% call appSummaryCard({ 'classes': 'govuk-!-margin-bottom-0' }) %}
        <table class="govuk-table">
          <thead class="govuk-table__head">
            <tr class="govuk-table_row">
              <th scope="col" class="govuk-table__header">Field</th>
              <th scope="col" class="govuk-table__header">Value</th>
              <th scope="col" class="govuk-table__header"></th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for field in row.keys() %}
              {% if field != 'entity' %}
                {%- if field not in ["geometry","point","organisation-entity","json"] or row[field] is not none  %}
                  <tr class="govuk-table__row">
                    <th scope="row" class="app-table__header app-table__header--row">
                      {{ entityField(field,fields,dataset_fields) }}
                    </th>
                    <td class="govuk-table__cell app-table__cell">
                      {{ entityValue(field,row[field],fields,dataset_fields)}}
                    </td>
                    {% if field is not in['dataset','organisation-entity','start-date','end-date','typology'] %}
                      <td class="govuk-table__cell govuk-!-font-size-14 govuk-!-text-align-right">
                        <a href="/fact?dataset={{row['dataset']}}&entity={{row['entity']}}&field={{field}}" class="govuk-link">Facts</a>
                      </td>
                    {% else %}
                      <td class="govuk-table__cell govuk-!-font-size-14 govuk-!-text-align-right"></td>
                    {% endif %}
                  </tr>
                {%- endif %}
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      {% endcall %}

      {% set jsonHTML %}
        <pre class="govuk-!-margin-0"><code class="language-json app-code-block app-code-block-overflow">{{row|digital_land_to_json}}</code></pre>
      {% endset %}
      {% set geojsonHTML %}
        <pre class="govuk-!-margin-0"><code class="language-json app-code-block app-code-block-overflow">{{geojson|digital_land_to_json}}</code></pre>
      {% endset %}

      {% if geojson %}
        {% set params = {
          "title":"Available Code Snippets:",
          "items":[
            {
              "label":"JSON","id":"json","panel":{
                "html":jsonHTML
              }
            },
            {
              "label":"GeoJSON","id":"geojson","panel":{
                "html":geojsonHTML
              }
            }
          ],
          "classes": "govuk-tabs--entity  govuk-!-margin-bottom-0"
        } %}
      {% else %}
        {% set params = {
          "items":[
            {
              "label":"JSON","id":"json","panel":{
                "html":jsonHTML
              }
            }
          ],
          "classes": "govuk-tabs--entity govuk-!-margin-bottom-0"
        } %}
      {% endif %}
      {{ govukTabs(params) }}

      {% if dataset %}
      <div class="app-c-sources-panel govuk-!-margin-bottom-6">
          {{ dataset.attribution_text | render_markdown() }}
          {{ dataset.licence_text  | render_markdown()}}
      </div>
      {% endif %}

    </div>

    <div class="govuk-grid-column-full">
    {% block recordGeometry -%}
      {%- if includesMap %}

      {% call appSummaryCard({
        'classes': 'govuk-!-margin-bottom-0',
        'titleText': 'Geographical area',
        'actions': {
          'items': [
            {
              'text': 'Download geojson',
              'href': '/entity/' + row["entity"] | string + '.geojson',
              'attributes': [
                {
                  'key': 'download',
                  'value': 'true'
                }
              ]
            }
          ],
        }
      }) %}

        {% set noteHTML %}<a class="js-hidden dl-link-national-map" href="#">See on national map.</a>{% endset %}

        {{- dlLeafletMap({
          "id": "dlMap",
          "wrapper_classes": "govuk-!-margin-top-4",
          "attributes": {
              "data-geojson-urls": geometry_url,
          },
          "height": "460",
          "notePanel": {
              "html": noteHTML
          }
        }) -}}
      {% endcall %}

      {%- endif %}
    {%- endblock recordGeometry %}
    </div>

    {%- if history_enabled %}
      <div id="history">
        {#{%- block entryHistory %}#}
        {#{%- endblock entryHistory %}#}
      </div>
    {%- endif %}

    {%- if provenance %}
      <div id="provenance">
        <h2 class="govuk-heading-m dl-subnav__heading">Provenance</h2>
      </div>
    {% endif -%}

    {% block recordReferences -%}
      {% if references %}
        <div id="referenced-by">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <h2 class="govuk-heading-m dl-subnav__heading">Referenced by</h2>
              <p class="govuk-body">This record is referenced by {{ references|total_items }} other planning related data record{{ "" if references|total_items == 1 else "s" }}.</p>
              {% if references|length > 0 -%}
                {% for type, refs in references.items() %}
                  <h3 class="govuk-heading-s">{{ type|capitalize }}</h3>
                  <ul class="govuk-list govuk-list--bullet">
                    {%- for ref in refs %}
                      <li>
                        <a href={{ entity_prefix|default('') }}{{ ref["href"] }}>{{ ref["text"] }}</a>
                        <span class="secondary-text data-reference">({{ ref["id"] }})</span>
                      </li>
                    {% endfor -%}
                  </ul>
                {% endfor %}
              {% endif -%}
            </div>
          </div>
        </div>
      {% endif %}
    {% endblock recordReferences -%}

  </div>
{%- endblock content %}}

{%- block pageScripts %}
  {%- if includesMap %}
    <script>
      const datasetName = "{{ pipeline_name }}"
      const hasPoint = ("{{ row.point }}" != "None" ? true : false);
      const hasGeometry = ("{{ row.geometry }}" == "None" ? false : true);
      // if it has a point but not a geometry then we want a maximum zoom to prevent vast nothingness
      const setMaxZoom = (hasPoint && !hasGeometry ? 14 : false);
      const $mapElement = document.querySelector('[data-module="boundary-map"]')
      const $nationalMapLink = document.querySelector('.dl-link-national-map')
      const mapParams = {
        maxZoom: setMaxZoom,
        initZoomCallback: function (featureGroup, map) {
          console.log("initial load completed")
          // do we need to check there isn't more than one shape?
          const center = featureGroup
            .getBounds()
            .getCenter()
          const zoom = map.getZoom()
          let url = `http://digital-land.info/map?layer=${datasetName}#${center.lat},${center.lng},${zoom}z`
            console
            .log(url)
          if ($nationalMapLink) {
            // only show this for the datasets we've added to the national map
            $nationalMapLink.href = url
            $nationalMapLink
              .classList
              .remove("js-hidden")
          }
        }
      }

      {% if geometry_url %}
        mapParams.geojsonURLs = ["{{ geometry_url }}"]
      {% elif geojson_features %}
        mapParams.geojsonFeatures = [{{ geojson_features|tojson }}]
      {% endif %}

      const mapComponent = new DLMaps
        .Map($mapElement)
        .init(mapParams)
    </script>
  {% endif %}

  <script>
    const $subNavTabs = document.querySelector('[data-module="dl-subnav"]')
    const subNavTabsComponent = new DLFrontend
      .SubNavTabs($subNavTabs)
      .init({})
  </script>

  <script>
    hljs.initHighlightingOnLoad();
  </script>

{%- endblock %}

{% extends "layouts/layout--full-width.html" %}
{% set templateName = "dl-info/national-map.html" %}

{%- from "components/map/macro.jinja" import map %}
{%- from "components/map-find-an-area-form/macro.jinja" import dlFindAnAreaForm %}

{% set containerClasses = 'dl-container--full-width' %}
{% set fullWidthHeader = true %}

{% set includesMap = true %}
{% block pageTitle %}Map of planning data for England | Planning Data{% endblock %}

{% set notePanel %}
  <p>
    Find, understand and download the <a href="/dataset" class="govuk-link">datasets used to create this map</a>.
    The basemap includes Ordnance Survey data. For further information, please refer to the <a href="https://labs.os.uk/licensing/public-viewing-terms.pdf" class="govuk-link" target="_blank">OS Public Viewing Terms</a>.
  </p>
{% endset %}

{%- block mapAssets %}
  <script src='/static/javascripts/maplibre-gl.js'></script>
  <link href='/static/stylesheets/maplibre-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  {{ super() }}
{% endblock -%}

{%- from "components/back-button/macro.jinja" import dlBackButton %}
{% block breadcrumbs%}
  {{ dlBackButton({
    "parentHref": '/'
  })}}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">Map of planning data for England</h1>
      <p id="aria-label-national-map" class="govuk-body-l">See the data we've collected and collated on a map.</p>
      {% include 'partials/data-coverage-banner.html' %}

      {{ dlFindAnAreaForm({
        "search_result": search_result,
        "search_query": search_query,
      }) }}
    </div>
  </div>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if search_result and search_result.type == 'lpa' and search_result.geometry %}
      {{
        map({
          'height': 700,
          'layers': layers,
          'DATASETTE_TILES_URL': settings.DATASETTE_TILES_URL,
          'TILES_URL': settings.TILES_URL,
          'notePanel': notePanel,
          'enableZoomControls': true,
          'enableLayerControls': true,
          'enableZoomCounter': true,
          'geojsons': [search_result.geometry],
          'paint_options': entity_paint_options,
        })
      }}
      {% else %}
      {{
        map({
          'height': 700,
          'layers': layers,
          'DATASETTE_TILES_URL': settings.DATASETTE_TILES_URL,
          'TILES_URL': settings.TILES_URL,
          'notePanel': notePanel,
          'enableZoomControls': true,
          'enableLayerControls': true,
          'enableZoomCounter': true,
        })
      }}
      {% endif %}

      <p class="govuk-body govuk-!-margin-bottom-0 govuk-!-width-two-thirds">This prototype map is automatically created using data from planning.data.gov.uk. Find out more <a href="/about">about the Planning Data Platform</a></p>

    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
{{ super() }}
  <script src="/static/javascripts/FindAnAreaForm.js"></script>
  <script>
    const searchResult = {{ search_result | tojson }};

    document.addEventListener('DOMContentLoaded', function () {
      new FindAnAreaForm(searchResult)
    })
  </script>

{% endblock %}
